# ContextFlow: Anki AI 动态语境插件

## 重要注意事项

* **平台兼容性**: Mac存在bug，由于本人没有mac设备，暂时无从修复，建议使用windows平台。欢迎MAC开发者提出PR协助解决
* **API限制**: 队列预测算法优化后，本地模型已经可以使用，但Gemini免费版有调用频率限制，依然不能使用。
* **字段设置**: 如果单词不在第一个字段，请在牌组名称后加上序号，如`所有卡片::英语[2]`
* **算法要求**: 请务必打开FSRS算法
* **缓存残留**:更改例句配置只能影响新缓存，无法修改已生成的部分，可以删除缓存文件，但要注意token的消耗。

## 推荐模型
* **doubao-seed-1-6-flash**: 价格便宜，够用
* **doubao-1.6-seed**: 性能优秀，性价比高
* **deepseekv3.1**: 有缓存命中功能，性能强劲，综合性价比高

## 简介

`ContextFlow` 是一款 Anki 插件，通过AI动态生成例句来改变外语词汇学习方式，将间隔重复系统与无限的、个性化的语境学习相结合。

## 核心功能

*   **动态 AI 例句**: 为每个单词的每次复习生成全新的、一次性的例句
*   **语境优先学习**: 卡片正面只显示例句，强制进行语境理解
*   **自定义提示词**: 除了修改固定字段，你甚至可以完全自定义提示词，拿来学成语，学古文，用知识点出题，随你开发
*   **例句保存**: 遇到喜欢的例句，可以保存在指定牌组反复阅读
*   **AI追问**: 困难的单词可以选中后提问，AI解答过程中的例句也可以即时保存
## 安装方法

**方法一（推荐）：通过 AnkiWeb 安装**
1. 打开 Anki 桌面版
2. 点击菜单栏的 `工具 (Tools)` -> `插件 (Add-ons)`
3. 点击 `获取插件 (Get Add-ons...)`
4. 输入插件代码：`932930811`
5. 点击 `确定 (OK)`，重启 Anki

**方法二：手动安装**
1. 下载最新的 `ContextFlow.ankiaddon` 文件
2. 打开 Anki，点击 `工具 (Tools)` -> `插件 (Add-ons)`
3. 将文件拖拽到插件列表窗口中
4. 重启 Anki

## 配置说明

1. 安装后点击 `工具 (Tools)` -> `AI句子生成配置... (ContextFlow Settings)`
2. 在设置界面中配置：
   - **API 接口地址**: 输入兼容 OpenAI 格式的 API 地址
   - **API 密钥**: 输入你的 API 密钥（注意保管好）
   - **模型名称**: 选择 AI 模型
   - **目标牌组名称**: 输入牌组完整名称+字段序号
   - **句子生成偏好** (可选): 调整词汇量等级、学习目标等参数
3. 点击 `保存` 应用设置

## 使用流程

1. 确保目标牌组第一个字段只包含单词本身
2. 打开FSRS算法
3. 像往常一样打开指定牌组进行复习
4. 卡片正面显示AI生成的例句，需要理解整个句子
5. 点击显示答案后，可以看到翻译和原始卡片内容
6. 根据理解程度点击复习按钮

## 界面展示

**配置界面**: 填写API设置、句子生成偏好和目标牌组
![img.png](picture/image.png)

**学习界面**: 显示正面例句，背面例句+翻译+原始卡片
![alt text](picture/image-2.png)

**AI追问界面**: 显示AI生成的例句，可点击提问
![alt text](picture/image-1.png)

## AI成本与能力计算
**价格：**
首先是Ai价格的问题，由于国产AI的内卷生态，价格实际上非常便宜，尤其是有阶梯式定价和输入缓存的模型。
如doubao-seed-1-6模型，以及qwen3-max模型，在32k上下文的短文本区间，价格仅需0.6元/百万token输入，和2元/百万token输出。
每次api调用会生成5个例句，每次调用会产生大约1000token的输入和300token的输出。
由于初期积累缓存几乎每次都需要调用api，我们算极端一些，极其勤奋，每天学习600张卡片，平均每3张调用一次，那么成本大约是每天0.24元，一个月7.2元。
这还只是顶级模型，极大使用量，不考虑优惠活动的结果，而实际上豆包的优惠活动已经从年初延续到年尾几乎完全免费了。

**能力：**
输出流程自然的语言是LLM最擅长，最突出的能力没有之一。
对于这个任务，哪怕是本地模型，都能以较高的质量完成，比如qwen3-14B。
即使是超小模型，如1B甚至0.5B模型也是可以输出流畅的语言的，即使它们甚至无法稳定输出一个标准的json格式供程序解析。

## Todo 开发计划

*  🔄 **Bug 修复与优化**: 据用户反馈和内部测试，持续查找并修复已知问题，优化插件的性能和稳定性，提升整体用户体验。
*  ✅ **API格式兼容**: 预设厂商url填写
*  ✅ **多语言选项**: 多种目标学习语言支持
*  ✅ **第二关键词**: 根据FSRS参数筛选用户最难掌握的单词作为第二关键词，加入Ai提示词以增加其出现频率，快速降低其难度参数（仅在难词超过100时自动启用，可在提示词中删除以关闭）
*  ✅ **提示词编辑**: 自定义提示词功能
*  ✅ **AI追问功能**: 支持选中单词提问，追问过程中的例句也可以即时保存
*  ✅ **例句保存**: 喜欢的例句可保存到指定牌组 
*  ✅ **缓存升级**: 从JSON升级到SQLite数据库，不再卡顿
*  ✅ **预测优化**: 询问ANKI开发者获取了内部的卡片队列接口，直接从ANKI核心获取学习队列，不必再手动预测队列，也不必须按照顺序学习，大大提升准确性和加载速度。
*  ✅ **单线程模式**: 适配本地ollama模型
*  ⬜ **多语言适配选项**: 为国外语言学习者提供支持
*  ⬜ **字体设置**: 允许用户自定义字体，提前适应考卷的字体
*  ⬜ **多组学习并行**:可以配置多个学习组，学习不同的语言或目标，各自有其独立的配置 
*  ⬜ **预设词库导入**: 提供预设的词汇列表，直接选择牌组而不用寻找第三方牌组库
*  ⬜ **TTS语音合成**: 为例句添加发音功能，以及正面只展示发音的听力练习功能（语音的API不好找，无限期等待中）